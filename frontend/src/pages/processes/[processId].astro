---
import Page from '../../components/Page.astro';
import Process from './process.svelte';

import processes from './processes.json';

import { getItemCount, burnItem } from '../inventory/utils.js';

const { processId } = Astro.params;
let success = true;

const process = processes.find((p) => p.id === processId);
const title = process.title || 'Process not found';

const machine = process.machine;
let machineCount = 0;

if (machine) {
    machineCount = getItemCount(Astro.request, machine);
}

const action = Astro.url.searchParams.get('action');

switch (action) {
    case 'start':
        onStart();
        break;
}

function onStart() {
    // Check each item in process.consumeItems to make sure we have enough
    for (const item of process.consumeItems) {
        const count = getItemCount(Astro.request, item.id);
        if (count < item.count) {
            console.log(`Not enough ${item.id} to start process`);
            // Not enough of this item
            return;
        }
    }

    // call burnItem for each item in process.consumeItems
    for (const item of process.consumeItems) {
        burnItem(Astro.request, Astro.response, item.id, item.count);
        console.log(`burned ${item.count} ${item.id}`);
    }
}
---

<Page title={title} columns="1">
    <Process processId={processId} machineCount={machineCount} client:idle />
</Page>