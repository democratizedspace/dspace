---
import Page from '../../../components/Page.astro';
import Card from '../../../components/Card.astro';
import ProgressBar from '../../../components/svelte/ProgressBar.svelte';
import quests from '../../../config/quests.json';
import SuggestCookies from '../../../components/SuggestCookies.astro';
import { hasAcceptedCookies } from '../../../utils';

const HOURS = 1000 * 60 * 60;
const DURATION = 1 * HOURS;

const { questId, stepId } = Astro.params;
let quest, questStep;

const shouldAcceptCookies = !hasAcceptedCookies(Astro.request);

try {
    quest = quests[questId];
    questStep = quest.steps[stepId];
} catch (e) {
    questStep = '';
}

if (!(shouldAcceptCookies) && questStep.checkpoint === true) {
    Astro.response.headers.append('Set-Cookie', `checkpoint-${questId}=${parseInt(questStep.id)}; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/`);
}

const getAction = (questOption) => {
    switch (questOption.action) {
        case 'quest':
            return `/quests/${questId}/${questOption.next}`;
        case 'path':
            return questOption.path;
        case 'longtask':
            return `/inventory/add/${questOption.addItem}/for/${questOption.duration}`;
        default:
            return '';
    }
}

const startTime = new Date(Date.now());

// Date.now() plus one hour as a Date type
const endTime = new Date(startTime.getTime() + DURATION);

let hoursFromNow = endTime.getTime() - startTime.getTime();
hoursFromNow = hoursFromNow / HOURS;

let output;
if (hoursFromNow === 1) {
    output = `in 1 hour`;
} else {
    output = `in ${hoursFromNow} hours`;
}

---

<Page message = {questStep.message || ""}>
    <SuggestCookies shouldSuggestCookies={shouldAcceptCookies} />
    {questStep.options && questStep.options.map((option) => (
        <Card
            image={option.image}
            href={getAction(option)}
            title={option.title}
            body={option.body}
            disabled={option.action === 'none'}
            duration={option.duration}
        >
        </Card>
    ))}
</Page>